import React, { useState, useRef, useEffect } from 'react';
import { Play, Pause, Download, Volume2, SkipBack, SkipForward } from 'lucide-react';

const QuranApp = () => {
  const surahs = [
    { number: 1, arabic: "الفاتحة", english: "Al-Fatihah", verses: 7 },
    { number: 2, arabic: "البقرة", english: "Al-Baqarah", verses: 286 },
    { number: 3, arabic: "آل عمران", english: "Aali Imran", verses: 200 },
    { number: 4, arabic: "النساء", english: "An-Nisa", verses: 176 },
    { number: 5, arabic: "المائدة", english: "Al-Ma'idah", verses: 120 },
    { number: 6, arabic: "الأنعام", english: "Al-An'am", verses: 165 },
    { number: 7, arabic: "الأعراف", english: "Al-A'raf", verses: 206 },
    { number: 8, arabic: "الأنفال", english: "Al-Anfal", verses: 75 },
    { number: 9, arabic: "التوبة", english: "At-Tawbah", verses: 129 },
    { number: 10, arabic: "يونس", english: "Yunus", verses: 109 },
    { number: 11, arabic: "هود", english: "Hud", verses: 123 },
    { number: 12, arabic: "يوسف", english: "Yusuf", verses: 111 },
    { number: 13, arabic: "الرعد", english: "Ar-Ra'd", verses: 43 },
    { number: 14, arabic: "ابراهيم", english: "Ibrahim", verses: 52 },
    { number: 15, arabic: "الحجر", english: "Al-Hijr", verses: 99 },
    { number: 16, arabic: "النحل", english: "An-Nahl", verses: 128 },
    { number: 17, arabic: "الإسراء", english: "Al-Isra", verses: 111 },
    { number: 18, arabic: "الكهف", english: "Al-Kahf", verses: 110 },
    { number: 19, arabic: "مريم", english: "Maryam", verses: 98 },
    { number: 20, arabic: "طه", english: "Ta-Ha", verses: 135 },
    { number: 21, arabic: "الأنبياء", english: "Al-Anbiya", verses: 112 },
    { number: 22, arabic: "الحج", english: "Al-Hajj", verses: 78 },
    { number: 23, arabic: "المؤمنون", english: "Al-Mu'minun", verses: 118 },
    { number: 24, arabic: "النور", english: "An-Nur", verses: 64 },
    { number: 25, arabic: "الفرقان", english: "Al-Furqan", verses: 77 },
    { number: 26, arabic: "الشعراء", english: "Ash-Shu'ara", verses: 227 },
    { number: 27, arabic: "النمل", english: "An-Naml", verses: 93 },
    { number: 28, arabic: "القصص", english: "Al-Qasas", verses: 88 },
    { number: 29, arabic: "العنكبوت", english: "Al-Ankabut", verses: 69 },
    { number: 30, arabic: "الروم", english: "Ar-Rum", verses: 60 },
    { number: 31, arabic: "لقمان", english: "Luqman", verses: 34 },
    { number: 32, arabic: "السجدة", english: "As-Sajdah", verses: 30 },
    { number: 33, arabic: "الأحزاب", english: "Al-Ahzab", verses: 73 },
    { number: 34, arabic: "سبإ", english: "Saba", verses: 54 },
    { number: 35, arabic: "فاطر", english: "Fatir", verses: 45 },
    { number: 36, arabic: "يس", english: "Ya-Sin", verses: 83 },
    { number: 37, arabic: "الصافات", english: "As-Saffat", verses: 182 },
    { number: 38, arabic: "ص", english: "Sad", verses: 88 },
    { number: 39, arabic: "الزمر", english: "Az-Zumar", verses: 75 },
    { number: 40, arabic: "غافر", english: "Ghafir", verses: 85 },
    { number: 41, arabic: "فصلت", english: "Fussilat", verses: 54 },
    { number: 42, arabic: "الشورى", english: "Ash-Shura", verses: 53 },
    { number: 43, arabic: "الزخرف", english: "Az-Zukhruf", verses: 89 },
    { number: 44, arabic: "الدخان", english: "Ad-Dukhan", verses: 59 },
    { number: 45, arabic: "الجاثية", english: "Al-Jathiyah", verses: 37 },
    { number: 46, arabic: "الأحقاف", english: "Al-Ahqaf", verses: 35 },
    { number: 47, arabic: "محمد", english: "Muhammad", verses: 38 },
    { number: 48, arabic: "الفتح", english: "Al-Fath", verses: 29 },
    { number: 49, arabic: "الحجرات", english: "Al-Hujurat", verses: 18 },
    { number: 50, arabic: "ق", english: "Qaf", verses: 45 },
    { number: 51, arabic: "الذاريات", english: "Adh-Dhariyat", verses: 60 },
    { number: 52, arabic: "الطور", english: "At-Tur", verses: 49 },
    { number: 53, arabic: "النجم", english: "An-Najm", verses: 62 },
    { number: 54, arabic: "القمر", english: "Al-Qamar", verses: 55 },
    { number: 55, arabic: "الرحمن", english: "Ar-Rahman", verses: 78 },
    { number: 56, arabic: "الواقعة", english: "Al-Waqi'ah", verses: 96 },
    { number: 57, arabic: "الحديد", english: "Al-Hadid", verses: 29 },
    { number: 58, arabic: "المجادلة", english: "Al-Mujadila", verses: 22 },
    { number: 59, arabic: "الحشر", english: "Al-Hashr", verses: 24 },
    { number: 60, arabic: "الممتحنة", english: "Al-Mumtahanah", verses: 13 },
    { number: 61, arabic: "الصف", english: "As-Saf", verses: 14 },
    { number: 62, arabic: "الجمعة", english: "Al-Jumu'ah", verses: 11 },
    { number: 63, arabic: "المنافقون", english: "Al-Munafiqun", verses: 11 },
    { number: 64, arabic: "التغابن", english: "At-Taghabun", verses: 18 },
    { number: 65, arabic: "الطلاق", english: "At-Talaq", verses: 12 },
    { number: 66, arabic: "التحريم", english: "At-Tahrim", verses: 12 },
    { number: 67, arabic: "الملك", english: "Al-Mulk", verses: 30 },
    { number: 68, arabic: "القلم", english: "Al-Qalam", verses: 52 },
    { number: 69, arabic: "الحاقة", english: "Al-Haqqah", verses: 52 },
    { number: 70, arabic: "المعارج", english: "Al-Ma'arij", verses: 44 },
    { number: 71, arabic: "نوح", english: "Nuh", verses: 28 },
    { number: 72, arabic: "الجن", english: "Al-Jinn", verses: 28 },
    { number: 73, arabic: "المزمل", english: "Al-Muzzammil", verses: 20 },
    { number: 74, arabic: "المدثر", english: "Al-Muddaththir", verses: 56 },
    { number: 75, arabic: "القيامة", english: "Al-Qiyamah", verses: 40 },
    { number: 76, arabic: "الانسان", english: "Al-Insan", verses: 31 },
    { number: 77, arabic: "المرسلات", english: "Al-Mursalat", verses: 50 },
    { number: 78, arabic: "النبإ", english: "An-Naba", verses: 40 },
    { number: 79, arabic: "النازعات", english: "An-Nazi'at", verses: 46 },
    { number: 80, arabic: "عبس", english: "Abasa", verses: 42 },
    { number: 81, arabic: "التكوير", english: "At-Takwir", verses: 29 },
    { number: 82, arabic: "الإنفطار", english: "Al-Infitar", verses: 19 },
    { number: 83, arabic: "المطففين", english: "Al-Mutaffifin", verses: 36 },
    { number: 84, arabic: "الإنشقاق", english: "Al-Inshiqaq", verses: 25 },
    { number: 85, arabic: "البروج", english: "Al-Buruj", verses: 22 },
    { number: 86, arabic: "الطارق", english: "At-Tariq", verses: 17 },
    { number: 87, arabic: "الأعلى", english: "Al-A'la", verses: 19 },
    { number: 88, arabic: "الغاشية", english: "Al-Ghashiyah", verses: 26 },
    { number: 89, arabic: "الفجر", english: "Al-Fajr", verses: 30 },
    { number: 90, arabic: "البلد", english: "Al-Balad", verses: 20 },
    { number: 91, arabic: "الشمس", english: "Ash-Shams", verses: 15 },
    { number: 92, arabic: "الليل", english: "Al-Layl", verses: 21 },
    { number: 93, arabic: "الضحى", english: "Ad-Duha", verses: 11 },
    { number: 94, arabic: "الشرح", english: "Ash-Sharh", verses: 8 },
    { number: 95, arabic: "التين", english: "At-Tin", verses: 8 },
    { number: 96, arabic: "العلق", english: "Al-Alaq", verses: 19 },
    { number: 97, arabic: "القدر", english: "Al-Qadr", verses: 5 },
    { number: 98, arabic: "البينة", english: "Al-Bayyinah", verses: 8 },
    { number: 99, arabic: "الزلزلة", english: "Az-Zalzalah", verses: 8 },
    { number: 100, arabic: "العاديات", english: "Al-Adiyat", verses: 11 },
    { number: 101, arabic: "القارعة", english: "Al-Qari'ah", verses: 11 },
    { number: 102, arabic: "التكاثر", english: "At-Takathur", verses: 8 },
    { number: 103, arabic: "العصر", english: "Al-Asr", verses: 3 },
    { number: 104, arabic: "الهمزة", english: "Al-Humazah", verses: 9 },
    { number: 105, arabic: "الفيل", english: "Al-Fil", verses: 5 },
    { number: 106, arabic: "قريش", english: "Quraysh", verses: 4 },
    { number: 107, arabic: "الماعون", english: "Al-Ma'un", verses: 7 },
    { number: 108, arabic: "الكوثر", english: "Al-Kawthar", verses: 3 },
    { number: 109, arabic: "الكافرون", english: "Al-Kafirun", verses: 6 },
    { number: 110, arabic: "النصر", english: "An-Nasr", verses: 3 },
    { number: 111, arabic: "المسد", english: "Al-Masad", verses: 5 },
    { number: 112, arabic: "الإخلاص", english: "Al-Ikhlas", verses: 4 },
    { number: 113, arabic: "الفلق", english: "Al-Falaq", verses: 5 },
    { number: 114, arabic: "الناس", english: "An-Nas", verses: 6 }
  ];

  const [currentSurah, setCurrentSurah] = useState(null);
  const [isPlaying, setIsPlaying] = useState(false);
  const [progress, setProgress] = useState(0);
  const [duration, setDuration] = useState(0);
  const [currentTime, setCurrentTime] = useState(0);
  const [searchTerm, setSearchTerm] = useState('');
  const audioRef = useRef(null);

  // Audio URL generator - Using EveryAyah.com API with Fares Abbad recitation
  const getAudioUrl = (surahNumber) => {
    const paddedNumber = String(surahNumber).padStart(3, '0');
    return `https://server8.mp3quran.net/frs_a/${paddedNumber}.mp3`;
  };

  useEffect(() => {
    const audio = audioRef.current;
    if (!audio) return;

    const updateProgress = () => {
      if (audio.duration) {
        setProgress((audio.currentTime / audio.duration) * 100);
        setCurrentTime(audio.currentTime);
        setDuration(audio.duration);
      }
    };

    const handleEnded = () => {
      setIsPlaying(false);
      setProgress(0);
      setCurrentTime(0);
    };

    audio.addEventListener('timeupdate', updateProgress);
    audio.addEventListener('ended', handleEnded);
    audio.addEventListener('loadedmetadata', updateProgress);

    return () => {
      audio.removeEventListener('timeupdate', updateProgress);
      audio.removeEventListener('ended', handleEnded);
      audio.removeEventListener('loadedmetadata', updateProgress);
    };
  }, []);

  const playSurah = (surah) => {
    if (currentSurah?.number === surah.number && isPlaying) {
      audioRef.current.pause();
      setIsPlaying(false);
    } else {
      if (currentSurah?.number !== surah.number) {
        setCurrentSurah(surah);
        audioRef.current.src = getAudioUrl(surah.number);
      }
      audioRef.current.play();
      setIsPlaying(true);
    }
  };

  const downloadSurah = (surah) => {
    const url = getAudioUrl(surah.number);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${surah.number}-${surah.english}.mp3`;
    a.click();
  };

  const playNext = () => {
    if (currentSurah && currentSurah.number < 114) {
      const nextSurah = surahs[currentSurah.number];
      setCurrentSurah(nextSurah);
      audioRef.current.src = getAudioUrl(nextSurah.number);
      audioRef.current.play();
      setIsPlaying(true);
    }
  };

  const playPrevious = () => {
    if (currentSurah && currentSurah.number > 1) {
      const prevSurah = surahs[currentSurah.number - 2];
      setCurrentSurah(prevSurah);
      audioRef.current.src = getAudioUrl(prevSurah.number);
      audioRef.current.play();
      setIsPlaying(true);
    }
  };

  const formatTime = (seconds) => {
    if (!seconds || isNaN(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const handleProgressClick = (e) => {
    const bar = e.currentTarget;
    const rect = bar.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    const newTime = percent * duration;
    audioRef.current.currentTime = newTime;
  };

  const filteredSurahs = surahs.filter(surah => 
    surah.arabic.includes(searchTerm) || 
    surah.english.toLowerCase().includes(searchTerm.toLowerCase()) ||
    surah.number.toString().includes(searchTerm)
  );

  return (
    <div className="min-h-screen bg-gradient-to-br from-emerald-50 to-teal-100">
      <audio ref={audioRef} />
      
      {/* Header */}
      <div className="bg-gradient-to-r from-emerald-600 to-teal-600 text-white p-6 shadow-lg">
        <div className="max-w-4xl mx-auto">
          <h1 className="text-3xl font-bold text-center mb-2">صوت القرآن</h1>
          <h2 className="text-xl text-center mb-4">Sawt Al Quran</h2>
          <p className="text-center text-emerald-100 text-sm">
            Qari: Fares Abbad | 114 Surahs
          </p>
        </div>
      </div>

      {/* Search Bar */}
      <div className="max-w-4xl mx-auto px-4 py-6">
        <input
          type="text"
          placeholder="Search Surah by name or number..."
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          className="w-full px-4 py-3 rounded-lg border border-emerald-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 shadow-sm"
        />
      </div>

      {/* Player */}
      {currentSurah && (
        <div className="max-w-4xl mx-auto px-4 mb-6">
          <div className="bg-white rounded-lg shadow-lg p-6">
            <div className="text-center mb-4">
              <h3 className="text-2xl font-bold text-emerald-800 mb-1">{currentSurah.arabic}</h3>
              <p className="text-lg text-gray-600">{currentSurah.english}</p>
              <p className="text-sm text-gray-500">Surah {currentSurah.number} • {currentSurah.verses} Verses</p>
            </div>

            {/* Progress Bar */}
            <div 
              className="bg-gray-200 h-2 rounded-full mb-2 cursor-pointer"
              onClick={handleProgressClick}
            >
              <div 
                className="bg-emerald-600 h-2 rounded-full transition-all"
                style={{ width: `${progress}%` }}
              />
            </div>
            
            <div className="flex justify-between text-xs text-gray-500 mb-4">
              <span>{formatTime(currentTime)}</span>
              <span>{formatTime(duration)}</span>
            </div>

            {/* Controls */}
            <div className="flex items-center justify-center gap-4">
              <button
                onClick={playPrevious}
                disabled={!currentSurah || currentSurah.number === 1}
                className="p-3 rounded-full bg-emerald-100 text-emerald-600 hover:bg-emerald-200 disabled:opacity-50 disabled:cursor-not-allowed transition"
              >
                <SkipBack size={20} />
              </button>
              
              <button
                onClick={() => playSurah(currentSurah)}
                className="p-4 rounded-full bg-emerald-600 text-white hover:bg-emerald-700 transition shadow-lg"
              >
                {isPlaying ? <Pause size={24} /> : <Play size={24} />}
              </button>
              
              <button
                onClick={playNext}
                disabled={!currentSurah || currentSurah.number === 114}
                className="p-3 rounded-full bg-emerald-100 text-emerald-600 hover:bg-emerald-200 disabled:opacity-50 disabled:cursor-not-allowed transition"
              >
                <SkipForward size={20} />
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Surah List */}
      <div className="max-w-4xl mx-auto px-4 pb-8">
        <div className="bg-white rounded-lg shadow-lg overflow-hidden">
          <div className="max-h-96 overflow-y-auto">
            {filteredSurahs.map((surah) => (
              <div
                key={surah.number}
                className={`border-b border-gray-100 hover:bg-emerald-50 transition ${
                  currentSurah?.number === surah.number ? 'bg-emerald-50' : ''
                }`}
              >
                <div className="p-4 flex items-center justify-between">
                  <div className="flex items-center gap-4 flex-1">
                    <div className="w-10 h-10 bg-emerald-600 text-white rounded-full flex items-center justify-center font-bold text-sm">
                      {surah.number}
                    </div>
                    <div className="flex-1">
                      <h3 className="font-bold text-lg text-gray-800">{surah.arabic}</h3>
                      <p className="text-sm text-gray-600">{surah.english} • {surah.verses} Verses</p>
                    </div>
                  </div>
                  
                  <div className="flex gap-2">
                    <button
                      onClick={() => playSurah(surah)}
                      className="p-2 rounded-full bg-emerald-100 text-emerald-600 hover:bg-emerald-200 transition"
                    >
                      {currentSurah?.number === surah.number && isPlaying ? (
                        <Pause size={20} />
                      ) : (
                        <Play size={20} />
                      )}
                    </button>
                    <button
                      onClick={() => downloadSurah(surah)}
                      className="p-2 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 transition"
                    >
                      <Download size={20} />
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Footer */}
      <div className="bg-emerald-800 text-white text-center py-4">
        <p className="text-sm">Sawt Al Quran • Complete Quran Audio Collection</p>
        <p className="text-xs text-emerald-200 mt-1">Made with ❤️ for the Ummah ( محمد كوثر ) </p>
      </div>
    </div>
  );
};

export default QuranApp;
